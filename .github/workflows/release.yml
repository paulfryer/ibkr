name: Build and Release SDK Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (semver format, e.g., 1.0.0 or 1.0.0-beta.1)'
        required: true
        type: string
      create_github_release:
        description: 'Create GitHub Release with packages'
        required: false
        type: boolean
        default: false
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write    # Required for creating releases
  packages: write    # Required for publishing packages
  id-token: write    # Required for NuGet Trusted Publishing (OIDC)

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 1: Validate Input
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  validate:
    name: 🔍 Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      version_tag: ${{ steps.validate.outputs.version_tag }}

    steps:
      - name: Validate semver format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"

          # Validate semver format (major.minor.patch with optional prerelease and build metadata)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "::error::❌ Invalid version format: $VERSION"
            echo "::error::Must follow semver (e.g., 1.0.0, 1.0.0-beta.1, 1.0.0+build.123)"
            exit 1
          fi

          echo "✅ Version $VERSION is valid semver"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$VERSION" >> $GITHUB_OUTPUT

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 2: Generate SDKs
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  generate-sdks:
    name: 🔧 Generate SDKs
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 📦 Install Kiota CLI
        run: dotnet tool install -g Microsoft.OpenApi.Kiota

      - name: 🔄 Restore generator dependencies
        working-directory: src/IBKR.Api.Generator
        run: dotnet restore

      - name: 🏗️ Build generator
        working-directory: src/IBKR.Api.Generator
        run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore

      - name: ⚙️ Generate both SDKs (NSwag + Kiota)
        working-directory: src/IBKR.Api.Generator
        run: |
          echo "Generating both NSwag and Kiota SDKs..."
          echo "0" | dotnet run --configuration ${{ env.CONFIGURATION }} --no-build
          echo "✅ SDK generation complete"

      - name: ✅ Verify generated projects
        run: |
          echo "🔍 Verifying all expected projects were generated..."

          EXPECTED_PROJECTS=(
            "src/NSwag/IBKR.Api.NSwag.Contract/IBKR.Api.NSwag.Contract.csproj"
            "src/NSwag/IBKR.Api.NSwag.Client/IBKR.Api.NSwag.Client.csproj"
            "src/Kiota/IBKR.Api.Kiota.Contract/IBKR.Api.Kiota.Contract.csproj"
            "src/Kiota/IBKR.Api.Kiota.Client/IBKR.Api.Kiota.Client.csproj"
          )

          ALL_FOUND=true
          for proj in "${EXPECTED_PROJECTS[@]}"; do
            if [ ! -f "$proj" ]; then
              echo "::error::❌ Missing expected project: $proj"
              ALL_FOUND=false
            else
              echo "  ✅ $proj"
            fi
          done

          if [ "$ALL_FOUND" = false ]; then
            exit 1
          fi

          echo "✅ All expected projects found"

      - name: 📤 Upload generated SDKs
        uses: actions/upload-artifact@v4
        with:
          name: generated-sdks
          path: |
            src/NSwag/
            src/Kiota/
            src/Directory.Build.props
          retention-days: 1
          if-no-files-found: error

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 3: Scaffold Test Infrastructure
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  scaffold-tests:
    name: 🧪 Scaffold Test Projects
    needs: [validate, generate-sdks]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: src/

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 🧪 Run test scaffold generator
        working-directory: src/IBKR.Api.TestScaffold
        run: |
          echo "🧪 Creating MockClient and Test projects..."
          dotnet run --configuration ${{ env.CONFIGURATION }}
          echo "✅ Test infrastructure scaffolding complete"

      - name: ✅ Verify test projects created
        run: |
          echo "🔍 Verifying test projects..."

          EXPECTED_PROJECTS=(
            "src/NSwag/IBKR.Api.NSwag.MockClient/IBKR.Api.NSwag.MockClient.csproj"
            "src/NSwag/IBKR.Api.NSwag.Tests/IBKR.Api.NSwag.Tests.csproj"
            "src/Kiota/IBKR.Api.Kiota.MockClient/IBKR.Api.Kiota.MockClient.csproj"
            "src/Kiota/IBKR.Api.Kiota.Tests/IBKR.Api.Kiota.Tests.csproj"
          )

          for proj in "${EXPECTED_PROJECTS[@]}"; do
            if [ -f "$proj" ]; then
              echo "  ✅ $proj"
            else
              echo "  ℹ️  $proj (may already exist - preserved)"
            fi
          done

      - name: 📤 Upload complete source (with tests)
        uses: actions/upload-artifact@v4
        with:
          name: sdks-with-tests
          path: |
            src/NSwag/
            src/Kiota/
            src/IBKR.Sdk.Contract/
            src/IBKR.Sdk.Client/
            src/IBKR.Sdk.Authentication/
            src/IBKR.Sdk.Tests/
            src/Directory.Build.props
          retention-days: 1
          if-no-files-found: error

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 4: Build and Package NSwag SDK (Parallel)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-nswag:
    name: 📦 Build NSwag SDK
    needs: [validate, scaffold-tests]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download generated SDKs (with tests)
        uses: actions/download-artifact@v4
        with:
          name: sdks-with-tests
          path: src/

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 💾 Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: 🔄 Restore NSwag dependencies
        working-directory: src/NSwag
        run: |
          dotnet restore IBKR.Api.NSwag.Contract/IBKR.Api.NSwag.Contract.csproj
          dotnet restore IBKR.Api.NSwag.Client/IBKR.Api.NSwag.Client.csproj

      - name: 🏗️ Build NSwag Contract
        working-directory: src/NSwag
        run: |
          dotnet build IBKR.Api.NSwag.Contract/IBKR.Api.NSwag.Contract.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ needs.validate.outputs.version }}

      - name: 🏗️ Build NSwag Client
        working-directory: src/NSwag
        run: |
          dotnet build IBKR.Api.NSwag.Client/IBKR.Api.NSwag.Client.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ needs.validate.outputs.version }}

      - name: 📦 Pack NuGet packages
        working-directory: src/NSwag
        run: |
          mkdir -p ../../packages/NSwag

          echo "📦 Packing NSwag.Contract..."
          dotnet pack IBKR.Api.NSwag.Contract/IBKR.Api.NSwag.Contract.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output ../../packages/NSwag \
            /p:PackageVersion=${{ needs.validate.outputs.version }}

          echo "📦 Packing NSwag.Client..."
          dotnet pack IBKR.Api.NSwag.Client/IBKR.Api.NSwag.Client.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output ../../packages/NSwag \
            /p:PackageVersion=${{ needs.validate.outputs.version }}

      - name: 📋 List generated packages
        working-directory: packages/NSwag
        run: |
          echo "📦 NSwag packages created:"
          ls -lh *.nupkg

      - name: 📤 Upload NSwag packages
        uses: actions/upload-artifact@v4
        with:
          name: NSwag-SDK-v${{ needs.validate.outputs.version }}
          path: packages/NSwag/*.nupkg
          retention-days: 90
          if-no-files-found: error

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 5: Build and Package Kiota SDK (Parallel)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-kiota:
    name: 📦 Build Kiota SDK
    needs: [validate, scaffold-tests]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download generated SDKs (with tests)
        uses: actions/download-artifact@v4
        with:
          name: sdks-with-tests
          path: src/

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 💾 Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: 🔄 Restore Kiota dependencies
        working-directory: src/Kiota
        run: |
          dotnet restore IBKR.Api.Kiota.Contract/IBKR.Api.Kiota.Contract.csproj
          dotnet restore IBKR.Api.Kiota.Client/IBKR.Api.Kiota.Client.csproj

      - name: 🏗️ Build Kiota Contract
        working-directory: src/Kiota
        run: |
          dotnet build IBKR.Api.Kiota.Contract/IBKR.Api.Kiota.Contract.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ needs.validate.outputs.version }}

      - name: 🏗️ Build Kiota Client
        working-directory: src/Kiota
        run: |
          dotnet build IBKR.Api.Kiota.Client/IBKR.Api.Kiota.Client.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ needs.validate.outputs.version }}

      - name: 📦 Pack NuGet packages
        working-directory: src/Kiota
        run: |
          mkdir -p ../../packages/Kiota

          echo "📦 Packing Kiota.Contract..."
          dotnet pack IBKR.Api.Kiota.Contract/IBKR.Api.Kiota.Contract.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output ../../packages/Kiota \
            /p:PackageVersion=${{ needs.validate.outputs.version }}

          echo "📦 Packing Kiota.Client..."
          dotnet pack IBKR.Api.Kiota.Client/IBKR.Api.Kiota.Client.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output ../../packages/Kiota \
            /p:PackageVersion=${{ needs.validate.outputs.version }}

      - name: 📋 List generated packages
        working-directory: packages/Kiota
        run: |
          echo "📦 Kiota packages created:"
          ls -lh *.nupkg

      - name: 📤 Upload Kiota packages
        uses: actions/upload-artifact@v4
        with:
          name: Kiota-SDK-v${{ needs.validate.outputs.version }}
          path: packages/Kiota/*.nupkg
          retention-days: 90
          if-no-files-found: error

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 6: Build and Package Clean API (after NSwag completes)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-clean-api:
    name: 📦 Build Clean API
    needs: [validate, scaffold-tests, build-nswag]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download generated SDKs (with tests)
        uses: actions/download-artifact@v4
        with:
          name: sdks-with-tests
          path: src/

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 💾 Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: 🔄 Restore dependencies
        run: |
          dotnet restore src/IBKR.Sdk.Contract/IBKR.Sdk.Contract.csproj
          dotnet restore src/IBKR.Sdk.Authentication/IBKR.Sdk.Authentication.csproj
          dotnet restore src/IBKR.Sdk.Client/IBKR.Sdk.Client.csproj

      - name: 🏗️ Build Clean API Contract
        run: |
          dotnet build src/IBKR.Sdk.Contract/IBKR.Sdk.Contract.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ needs.validate.outputs.version }}

      - name: 🏗️ Build Authentication
        run: |
          dotnet build src/IBKR.Sdk.Authentication/IBKR.Sdk.Authentication.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ needs.validate.outputs.version }}

      - name: 🏗️ Build Clean API Client
        run: |
          dotnet build src/IBKR.Sdk.Client/IBKR.Sdk.Client.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ needs.validate.outputs.version }}

      - name: 📦 Pack NuGet packages
        run: |
          mkdir -p packages/CleanAPI

          echo "📦 Packing IBKR.Sdk.Contract..."
          dotnet pack src/IBKR.Sdk.Contract/IBKR.Sdk.Contract.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output packages/CleanAPI \
            /p:PackageVersion=${{ needs.validate.outputs.version }}

          echo "📦 Packing IBKR.Sdk.Authentication..."
          dotnet pack src/IBKR.Sdk.Authentication/IBKR.Sdk.Authentication.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output packages/CleanAPI \
            /p:PackageVersion=${{ needs.validate.outputs.version }}

          echo "📦 Packing IBKR.Sdk.Client..."
          dotnet pack src/IBKR.Sdk.Client/IBKR.Sdk.Client.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --output packages/CleanAPI \
            /p:PackageVersion=${{ needs.validate.outputs.version }}

      - name: 📋 List generated packages
        working-directory: packages/CleanAPI
        run: |
          echo "📦 Clean API packages created:"
          ls -lh *.nupkg

      - name: 📤 Upload Clean API packages
        uses: actions/upload-artifact@v4
        with:
          name: CleanAPI-SDK-v${{ needs.validate.outputs.version }}
          path: packages/CleanAPI/*.nupkg
          retention-days: 90
          if-no-files-found: error

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 7: Test NSwag SDK (Parallel)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  test-nswag:
    name: ✅ Test NSwag SDK
    needs: [validate, build-nswag, scaffold-tests]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download SDKs with tests
        uses: actions/download-artifact@v4
        with:
          name: sdks-with-tests
          path: src/

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 🧪 Run NSwag tests (with mocks)
        working-directory: src/NSwag
        run: |
          if [ -d "IBKR.Api.NSwag.Tests" ]; then
            echo "🧪 Running NSwag tests..."
            dotnet test IBKR.Api.NSwag.Tests/IBKR.Api.NSwag.Tests.csproj \
              --configuration ${{ env.CONFIGURATION }} \
              --logger "trx;LogFileName=test-results.trx" \
              --logger "console;verbosity=detailed"
            echo "✅ NSwag tests passed"
          else
            echo "ℹ️  No test project found (may not exist yet)"
          fi

      - name: 📤 Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nswag-test-results
          path: src/NSwag/IBKR.Api.NSwag.Tests/TestResults/*.trx
          retention-days: 30
          if-no-files-found: ignore

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 8: Test Kiota SDK (Parallel)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  test-kiota:
    name: ✅ Test Kiota SDK
    needs: [validate, build-kiota, scaffold-tests]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download SDKs with tests
        uses: actions/download-artifact@v4
        with:
          name: sdks-with-tests
          path: src/

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 🧪 Run Kiota tests (with mocks)
        working-directory: src/Kiota
        run: |
          if [ -d "IBKR.Api.Kiota.Tests" ]; then
            echo "🧪 Running Kiota tests..."
            dotnet test IBKR.Api.Kiota.Tests/IBKR.Api.Kiota.Tests.csproj \
              --configuration ${{ env.CONFIGURATION }} \
              --logger "trx;LogFileName=test-results.trx" \
              --logger "console;verbosity=detailed"
            echo "✅ Kiota tests passed"
          else
            echo "ℹ️  No test project found (may not exist yet)"
          fi

      - name: 📤 Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kiota-test-results
          path: src/Kiota/IBKR.Api.Kiota.Tests/TestResults/*.trx
          retention-days: 30
          if-no-files-found: ignore

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 9: Test Clean API (Parallel)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  test-clean-api:
    name: ✅ Test Clean API
    needs: [validate, build-clean-api, scaffold-tests]
    runs-on: ubuntu-latest
    env:
      Testing__UseMockClient: true

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download SDKs with tests
        uses: actions/download-artifact@v4
        with:
          name: sdks-with-tests
          path: src/

      - name: 🔨 Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 🧪 Run Clean API tests (with mocks)
        run: |
          echo "🧪 Running Clean API tests with mocks..."
          echo "   Testing:UseMockClient = $Testing__UseMockClient"

          dotnet test src/IBKR.Sdk.Tests/IBKR.Sdk.Tests.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=detailed"

          echo "✅ Clean API tests passed"

      - name: 📤 Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clean-api-test-results
          path: src/IBKR.Sdk.Tests/TestResults/*.trx
          retention-days: 30
          if-no-files-found: ignore

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 10: Create Release Summary
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  create-summary:
    name: 📊 Create Release Summary
    needs: [validate, build-nswag, build-kiota, build-clean-api, test-nswag, test-kiota, test-clean-api]
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Download all SDK packages
        uses: actions/download-artifact@v4
        with:
          pattern: '*-SDK-v*'
          path: all-packages

      - name: 📊 Generate summary
        run: |
          echo "# 🎉 IBKR SDK Release v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully built and packaged both NSwag and Kiota SDKs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## 📦 Generated Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for sdk_dir in all-packages/*/; do
            sdk_name=$(basename "$sdk_dir")
            echo "### ${sdk_name}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Package | Size | Symbols |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|---------|" >> $GITHUB_STEP_SUMMARY

            for pkg in "$sdk_dir"*.nupkg; do
              if [ -f "$pkg" ]; then
                name=$(basename "$pkg")
                size=$(du -h "$pkg" | cut -f1)

                # Check if symbols package exists
                snupkg="${pkg%.nupkg}.snupkg"
                if [ -f "$snupkg" ]; then
                  symbols_size=$(du -h "$snupkg" | cut -f1)
                  symbols="✅ ($symbols_size)"
                else
                  symbols="➖"
                fi

                echo "| \`$name\` | $size | $symbols |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "## 🚀 Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⭐ Clean API (Recommended)" >> $GITHUB_STEP_SUMMARY
          echo "Strongly-typed, production-ready abstraction with comprehensive error handling:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package IBKR.Sdk.Contract --version ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package IBKR.Sdk.Client --version ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package IBKR.Sdk.Authentication --version ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### NSwag SDK (Lower-level)" >> $GITHUB_STEP_SUMMARY
          echo "Service-oriented architecture with direct API access:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package IBKR.Api.NSwag.Contract --version ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package IBKR.Api.NSwag.Client --version ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Kiota SDK (Lower-level)" >> $GITHUB_STEP_SUMMARY
          echo "Fluent API architecture with request builders:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package IBKR.Api.Kiota.Contract --version ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package IBKR.Api.Kiota.Client --version ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## 📥 Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Navigate to the **Actions** tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Click on this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Scroll to the **Artifacts** section" >> $GITHUB_STEP_SUMMARY
          echo "4. Download the SDK packages (90-day retention)" >> $GITHUB_STEP_SUMMARY

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 11: Create GitHub Release (Optional)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  create-release:
    name: 🚀 Create GitHub Release
    needs: [validate, build-nswag, build-kiota, build-clean-api]
    if: inputs.create_github_release
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download all packages
        uses: actions/download-artifact@v4
        with:
          pattern: '*-SDK-v*'
          path: release-artifacts

      - name: 📦 Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -name "*.nupkg" -exec cp {} release-files/ \;
          find release-artifacts -name "*.snupkg" -exec cp {} release-files/ \;

          echo "📦 Release files:"
          ls -lh release-files/

      - name: 🚀 Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version_tag }}
          name: IBKR API SDK ${{ needs.validate.outputs.version_tag }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          body: |
            # IBKR API SDK ${{ needs.validate.outputs.version_tag }}

            Auto-generated C# SDKs for the Interactive Brokers REST API with a clean, production-ready abstraction layer.

            ## 📦 Packages Included

            ### ⭐ Clean API (Recommended)
            Production-ready abstraction with comprehensive error handling and logging:
            - **IBKR.Sdk.Contract** - Clean interfaces and strongly-typed models
            - **IBKR.Sdk.Client** - Production-ready implementation with built-in workarounds
            - **IBKR.Sdk.Authentication** - Thread-safe authentication provider

            ### NSwag SDK (Lower-level)
            Service-oriented architecture with direct API access:
            - **IBKR.Api.NSwag.Contract** - Generated models and service interfaces
            - **IBKR.Api.NSwag.Client** - HTTP client implementations

            ### Kiota SDK (Lower-level)
            Fluent API architecture with request builders:
            - **IBKR.Api.Kiota.Contract** - Generated model classes (POCOs)
            - **IBKR.Api.Kiota.Client** - Fluent request builders

            ## 🚀 Installation

            ### Recommended: Clean API
            ```bash
            dotnet add package IBKR.Sdk.Contract --version ${{ needs.validate.outputs.version }}
            dotnet add package IBKR.Sdk.Client --version ${{ needs.validate.outputs.version }}
            dotnet add package IBKR.Sdk.Authentication --version ${{ needs.validate.outputs.version }}
            ```

            ### Alternative: NSwag SDK
            ```bash
            dotnet add package IBKR.Api.NSwag.Contract --version ${{ needs.validate.outputs.version }}
            dotnet add package IBKR.Api.NSwag.Client --version ${{ needs.validate.outputs.version }}
            ```

            ### Alternative: Kiota SDK
            ```bash
            dotnet add package IBKR.Api.Kiota.Contract --version ${{ needs.validate.outputs.version }}
            dotnet add package IBKR.Api.Kiota.Client --version ${{ needs.validate.outputs.version }}
            ```

            ## 📖 Documentation

            See the [repository README](https://github.com/paulfryer/ibkr) for usage examples and API documentation.

            ## ✨ What's New in Clean API

            - **Strongly-typed models** - DateTime, enums, decimals (no magic strings!)
            - **Comprehensive error handling** - Detailed error messages with full context
            - **Built-in workarounds** - Handles API quirks automatically
            - **Production-ready** - Battle-tested with comprehensive test suite
            - **Excellent DX** - Clean, intuitive API surface

            ## 🔍 Testing

            All SDKs include comprehensive test suites with MockClient packages for testing purposes.
          files: |
            release-files/*.nupkg
            release-files/*.snupkg

  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # JOB 12: Publish to NuGet.org (Optional)
  #━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  publish-nuget:
    name: 📤 Publish to NuGet.org
    needs: [validate, build-nswag, build-kiota, build-clean-api, test-nswag, test-kiota, test-clean-api]
    if: inputs.create_github_release  # Only publish when creating a GitHub release
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Download all packages
        uses: actions/download-artifact@v4
        with:
          pattern: '*-SDK-v*'
          path: packages-to-publish

      - name: 📦 Consolidate packages
        run: |
          mkdir -p nuget-packages
          find packages-to-publish -name "*.nupkg" -exec cp {} nuget-packages/ \;
          find packages-to-publish -name "*.snupkg" -exec cp {} nuget-packages/ \;

          echo "📦 Packages to publish:"
          ls -lh nuget-packages/

      - name: 🚀 Publish to NuGet.org using Trusted Publishing
        run: |
          echo "🚀 Publishing packages to NuGet.org using Trusted Publishing (OIDC)..."

          for package in nuget-packages/*.nupkg; do
            if [ -f "$package" ]; then
              echo "📤 Publishing: $(basename $package)"
              dotnet nuget push "$package" \
                --source https://api.nuget.org/v3/index.json \
                --skip-duplicate
            fi
          done

          echo "✅ All packages published successfully!"

      - name: 📊 Publication Summary
        run: |
          echo "# 📦 NuGet Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully published to NuGet.org:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## IBKR SDK Packages" >> $GITHUB_STEP_SUMMARY
          echo "- [IBKR.Sdk.Contract ${{ needs.validate.outputs.version }}](https://www.nuget.org/packages/IBKR.Sdk.Contract/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [IBKR.Sdk.Client ${{ needs.validate.outputs.version }}](https://www.nuget.org/packages/IBKR.Sdk.Client/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [IBKR.Sdk.Authentication ${{ needs.validate.outputs.version }}](https://www.nuget.org/packages/IBKR.Sdk.Authentication/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## NSwag SDK Packages" >> $GITHUB_STEP_SUMMARY
          echo "- [IBKR.Api.NSwag.Contract ${{ needs.validate.outputs.version }}](https://www.nuget.org/packages/IBKR.Api.NSwag.Contract/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [IBKR.Api.NSwag.Client ${{ needs.validate.outputs.version }}](https://www.nuget.org/packages/IBKR.Api.NSwag.Client/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Kiota SDK Packages" >> $GITHUB_STEP_SUMMARY
          echo "- [IBKR.Api.Kiota.Contract ${{ needs.validate.outputs.version }}](https://www.nuget.org/packages/IBKR.Api.Kiota.Contract/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [IBKR.Api.Kiota.Client ${{ needs.validate.outputs.version }}](https://www.nuget.org/packages/IBKR.Api.Kiota.Client/${{ needs.validate.outputs.version }})" >> $GITHUB_STEP_SUMMARY
